<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chlorophyll Map</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <style>
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 8px;
            background: lightsteelblue;
            border-radius: 8px;
            pointer-events: none;
        }
        .country {
            stroke: #fff;
            stroke-width: 1.5px;
        }
        .legend {
            font-size: 12px;
            font-family: sans-serif;
        }
    </style>
</head>
<body>
    <div>
        <label for="year-filter">Select Year:</label>
        <select id="year-filter"></select>
        <button id="update-map">Update Map</button>
    </div>
    <div id="map"></div>

    <script>
        let chlorophyllData;
        let selectedYear = 2021;  // Default year
        let chlorophyllScale;  // Color scale for chlorophyll levels

        // Fetch the chlorophyll data and the world map (geoJSON)
        Promise.all([
            fetch('reformatted_chlorophyll_data.json').then(response => response.json()), // Chlorophyll data
            fetch('world-110m.json').then(response => response.json()) // GeoJSON for the map
        ]).then(([chlorophyllDataJson, worldData]) => {
            chlorophyllData = chlorophyllDataJson;

            // Create a color scale for chlorophyll concentration
            chlorophyllScale = d3.scaleSequential(d3.interpolateGreens)
                .domain([0, d3.max(chlorophyllData.map(d => d.Chlorophyll))]);

            // Populate year dropdown and render the initial map
            populateYearDropdown(chlorophyllData);
            renderMap(worldData, chlorophyllData);
        }).catch(error => console.error('Error fetching data:', error));

        // Function to populate the year dropdown
        function populateYearDropdown(data) {
            const yearFilter = d3.select("#year-filter");
            const years = Array.from(new Set(data.map(d => d.Year))).sort((a, b) => a - b);

            years.forEach(year => {
                yearFilter.append("option").attr("value", year).text(year);
            });

            // Listen for year changes
            yearFilter.on("change", function() {
                selectedYear = +this.value;
                updateMap();
            });
        }

        // Function to render the world map with chlorophyll data
        function renderMap(worldData, chlorophyllData) {
            const width = 960, height = 600;

            // Set up map projection
            const projection = d3.geoMercator()
                .scale(150)
                .translate([width / 2, height / 2]);

            const path = d3.geoPath().projection(projection);

            // Add SVG container for the map
            const svg = d3.select("#map").append("svg")
                .attr("width", width)
                .attr("height", height);

            // Add a tooltip
            const tooltip = d3.select("body").append("div").attr("class", "tooltip").style("opacity", 0);

            // Draw the map using topoJSON
            const countries = topojson.feature(worldData, worldData.objects.countries).features;

            svg.selectAll(".country")
                .data(countries)
                .enter().append("path")
                .attr("class", "country")
                .attr("d", path)
                .style("fill", d => {
                    const countryData = chlorophyllData.find(cd => cd.Country === d.properties.name && cd.Year === selectedYear);
                    return countryData ? chlorophyllScale(countryData.Chlorophyll) : '#ccc';
                })
                .on("mouseover", (event, d) => {
                    const countryData = chlorophyllData.find(cd => cd.Country === d.properties.name && cd.Year === selectedYear);
                    if (countryData) {
                        tooltip.transition().duration(200).style("opacity", 1);
                        tooltip.html(`
                            Country: ${d.properties.name}<br>
                            Chlorophyll: ${countryData.Chlorophyll}
                        `)
                            .style("left", (event.pageX + 5) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    }
                })
                .on("mouseout", () => tooltip.transition().duration(500).style("opacity", 0));
        }

        // Function to update the map when the year or data changes
        function updateMap() {
            const countries = d3.selectAll(".country");
            countries.style("fill", d => {
                const countryData = chlorophyllData.find(cd => cd.Country === d.properties.name && cd.Year === selectedYear);
                return countryData ? chlorophyllScale(countryData.Chlorophyll) : '#ccc';
            });
        }
    </script>
</body>
</html>
